# [译]SQL不是回避 DevOps 的理由

自动化＋一些原则让测试更有效、发布周期更短，而且商业风险更低。
by Thomas A.Limoncelli

有朋友最近告诉笔者，”我们做不了 DevOps，我们使用了关系数据库。“笔者听罢，差点从椅子上摔倒。这个观点在很多层面都是错误的。
”你不了解我的处境！“他拒绝道。”DevOps 意味着我们需要更高频率的部署我们软件的发布版本！现在我们不能控制部署，我们一年只有很少的时间可以干这个。“

笔者追问朋友当前的部署流程。

”每隔几个月我们会有新版发布“，他解释道。”将其部署到生产线需要很多工作。由于我们使用 SQL，部署过程会是这样：第一，我们踢掉所有用户，关闭应用服务。下一步，DBA 修改数据库的 schema。一旦他们的工作完成，新版软件就安装完毕，可以使用了。整个过程花费好几个小时，所以我们一般安排在周末进行……（这让人讨厌）。如果升级失败，我们不得不使用备份的磁带，将一切恢复到初始状态，然后再试一次。“

他总结道，”仅是规划一次升级部署都需要好几周的协商。我们通常都很难达成共识，这也是为什么我们需要在周末来处理升级。每隔几个月做一次都很痛苦，要面对来自方方面面的压力！我听说一些公司每天能做好几次软件发布。如果我们那样做，我们的应用系统就会因为升级而一直处于下线状态了！“
这里有很多没有说清楚的地方。让我先澄清一些误解。之后再讨论采用一些技术手段，让部署更容易。

**首先，DevOps 不是一项技术，它是一套方法论。** 关于 DevOps 最精确的定义是，应用敏捷、精益的方法到从源码到部署的全过程。它是为了更快速的交付价值，或者说是用短的时间让一个需求特性从想法转变为生产系统的功能。更高频率的发布意味着减少已经就绪的特性等待上线的时间。

DevOps 不需要禁止任何特殊的数据库技术。反过来，任何技术也不是不是采用和不采用 DevOps 的理由，就像使用特殊的语言不是阻碍将敏捷应有到项目中的理由。SQL 是常见的理由，但也是经不起推敲的。

很理解 DevOps 在一些人头脑里是如何与少 SQL 数据库关联在一起。在2000年到2010年左右，投资和实践 DevOps 的公司大部分是大型网站，它们的共识是推行 NoSQL 数据库（键值存储）。然而两者的联系造成了因果的混淆。这些公司还向员工免费提供丰盛的午餐，但我们都同意这不是 DevOps 的前置条件。

**第二，我不确定一些人是否可以做 DevOps。** 你可以使用 DevOps 的技术、方法或其他。也就是说，人们已经很频繁的使用这个词，以致于我想我已经无法去有效讨论这个问题。

朋友们有一个共识。”看“，他困惑道，”这些部署是危险的。坦白讲，每次我们实施的时候都在拿公司的数据，甚至我的工作在冒险。每隔几个月做一次已经压力很大了，还需要更频繁的做吗？不！先生，那是不负责任！“

在之前的专栏中提到（[小批量原则](https://queue.acm.org/detail.cfm?id=2945077) )，当一件事情是高风险的时候，我们会倾向于更少的去尝试做它。但与常识相悖的是，这种做法恰恰会增加风险。下次当你做危险的事情时，你应该更多的实践，针对周围环境而累积的变化会越来越大，越容易造成因为未知的副作用导致失败。相应的，DevOps采取的做法是，危险的事情应该更频繁的去做。高频次的做法会尽早暴露大大小小的问题，而不是每年一次的大扫除。它强迫我们将过程自动化，自动测试整个过程，让过程更流畅，这样风险会降低。它仍人们更多参与到实践中。实践出精品。不再回避我们恐惧的东西，帮助我们跨越危险，克服挑战。像任何经历过术后恢复的人一样，我们不断的实践直到它不再痛苦为止。

部署有一些固定成本。原则上，你需要逐渐将这些固定成本降低。如果增加部署频率而不降低固定成本，则会伤害业务，这是不负责任的。

该文章其余部分描述了两种实践，让你即使使用 SQL也可以快速发布。实施它们需要开发者、质控、运维走出各自的筒仓，彼此协作，这也是 DevOps 的实质。这样的结果是让业务更平滑、更少痛苦、更少压力。

## 技术1：自动 Schema 更新

在这个古老的方法论中，当团队中的专家（通常为 DBA）手工修改 schema 时，任何 schema 的变化都需要整个应用系统关闭。如果你希望实现自动化部署，你需要自动化实现 schema 的更新。

因此，应用需要管理 schema。每个 schema 的版本都需要记录。应用从 schema V1版开始。这个值存在数据库中（大致为1列的表，该列字段存储为1）。当应用启动时，它需要知道兼容 V1的schema，如果它在数据库中找不到这个版本，它可以拒绝运行。

为了自动更新 schema，下一版本的软件发布时需要知道自己要求V2版的 schema，知道 SQL 命令会将 V1版的 schema 升级到 V2版。在启动时，它看到版本为1，然后运行响应的 schema 升级命名，并将存在数据库中的版本号升级为2，之后继续运行应用。

执行这个操作的软件通常还有一个存储 SQL schema 升级命令表。这些命令以数组存储，索引 n 表示其是支持从Vn-1升级到 Vn。这样，某个版本找不到也没有关系，软件能将数据库恢复到任意需要的schema版本。 实际上，如果发现有没有初始化的数据库（如在测试环境中），它会循环执行若干schema 升级，直到获取到最新的版本。